(function(n,t){"use strict";function w(n){for(var t in n)if(n.hasOwnProperty(t)&&!(n[t]instanceof Object||t==="overlay"))return!0;return!1}function e(n,t,i,r){if(i){var u=i-r,f=/max/.test(t);(f&&u<0||!f&&u>0)&&(n.errors||(n.errors={}),n.errors[t]=Math.abs(u))}}function y(n,t,i,r){if(n){var u=i.length-(n-t);u>0&&f(i.splice(0,u),function(n,t){e(n,"maxFiles",-1,t);r.push(n)})}}var u=n.noop,p=!n.fn.prop,h=p?"attr":"prop",c="data-fileapi",s="data-fileapi-id",l=[].slice,f=t.each,o=t.extend,r=function(n,t){var i=l.call(arguments,2);return t.bind?t.bind.apply(t,[n].concat(i)):function(){return t.apply(n,i.concat(l.call(arguments)))}},i=function(n){return"["+c+'="'+n+'"]'},v=function(n){return n.indexOf("#")===0},a=function(t,e){var h,o,s;this.$el=t=n(t).on("change.fileapi",'input[type="file"]',r(this,this._onSelect));this.el=t[0];this._options={};this.options={url:0,data:{},accept:0,multiple:!1,paramName:0,dataType:"json",duplicate:!1,uploadRetry:0,networkDownRetryTimeout:5e3,chunkSize:0,chunkUploadRetry:3,chunkNetworkDownRetryTimeout:2e3,maxSize:0,maxFiles:0,imageSize:0,sortFn:0,filterFn:0,autoUpload:!1,clearOnSelect:void 0,clearOnComplete:void 0,lang:{B:"bytes",KB:"KB",MB:"MB",GB:"GB",TB:"TB"},sizeFormat:"0.00",imageOriginal:!0,imageTransform:0,imageAutoOrientation:!!FileAPI.support.exif,elements:{ctrl:{upload:i("ctrl.upload"),reset:i("ctrl.reset"),abort:i("ctrl.abort")},empty:{show:i("empty.show"),hide:i("empty.hide")},emptyQueue:{show:i("emptyQueue.show"),hide:i("emptyQueue.hide")},active:{show:i("active.show"),hide:i("active.hide")},size:i("size"),name:i("name"),progress:i("progress"),list:i("list"),file:{tpl:i("file.tpl"),progress:i("file.progress"),active:{show:i("file.active.show"),hide:i("file.active.hide")},preview:{el:0,get:0,width:0,height:0,processing:0},abort:i("file.abort"),remove:i("file.remove"),rotate:i("file.rotate")},dnd:{el:i("dnd"),hover:"dnd_hover",fallback:i("dnd.fallback")}},onDrop:u,onDropHover:u,onSelect:u,onBeforeUpload:u,onUpload:u,onProgress:u,onComplete:u,onFilePrepare:u,onFileUpload:u,onFileProgress:u,onFileComplete:u,onFileRemove:null,onFileRemoveCompleted:null};n.extend(!0,this.options,e);e=this.options;this.option("elements.file.preview.rotate",e.imageAutoOrientation);e.url||(h=this.$el.attr("action")||this.$el.find("form").attr("action"),h?e.url=h:this._throw("url â€” is not defined"));this.$files=this.$elem("list");this.$fileTpl=this.$elem("file.tpl");this.itemTplFn=n.fn.fileapi.tpl(n("<div/>").append(this.$elem("file.tpl")).html());f(e,function(n,t){this._setOption(t,n)},this);this.$el.on("reset.fileapi",r(this,this._onReset)).on("submit.fileapi",r(this,this._onSubmit)).on("upload.fileapi progress.fileapi complete.fileapi",r(this,this._onUploadEvent)).on("fileupload.fileapi fileprogress.fileapi filecomplete.fileapi",r(this,this._onFileUploadEvent)).on("click","["+c+"]",r(this,this._onActionClick));o=e.elements.ctrl;o&&(this._listen("click",o.reset,r(this,this._onReset)),this._listen("click",o.upload,r(this,this._onSubmit)),this._listen("click",o.abort,r(this,this._onAbort)));s=FileAPI.support.dnd;this.$elem("dnd.el",!0).toggle(s);this.$elem("dnd.fallback").toggle(!s);s&&this.$elem("dnd.el",!0).dnd(r(this,this._onDropHover),r(this,this._onDrop));this.$progress=this.$elem("progress");e.clearOnSelect===void 0&&(e.clearOnSelect=!e.multiple);this.clear();n.isArray(e.files)&&(this.files=n.map(e.files,function(t){return n.type(t)==="string"&&(t={src:t,name:t.split("/").pop(),type:/jpe?g|png|bmp|git|tiff?/i.test(t)&&"image/"+t.split(".").pop(),size:0}),t.complete=!0,t}),this._redraw())};a.prototype={constructor:a,_throw:function(n){throw"jquery.fileapi: "+n;},_getFiles:function(n,i){var o=this.options,c=o.maxSize,l=o.maxFiles,h=o.filterFn,a=this.files.length,s=t.getFiles(n),r={all:s,files:[],other:[],duplicate:o.duplicate?[]:this._extractDuplicateFiles(s)},u=o.imageSize,v=this;u||h?t.filterFiles(s,function(n,t){return t&&u&&(e(n,"minWidth",u.minWidth,t.width),e(n,"minHeight",u.minHeight,t.height),e(n,"maxWidth",u.maxWidth,t.width),e(n,"maxHeight",u.maxHeight,t.height)),e(n,"maxSize",c,n.size),!n.errors&&(!h||h(n,t))},function(n,t){y(l,a,n,t);r.other=t;r.files=n;i.call(v,r)}):(f(s,function(n){e(n,"maxSize",c,n.size);r[n.errors?"other":"files"].push(n)}),y(l,a,r.files,r.other),i.call(v,r))},_extractDuplicateFiles:function(n){for(var r=[],t=n.length,u=this.files,i;t--;)for(i=u.length;i--;)if(this._fileCompare(n[t],u[i])){r.push(n.splice(t,1));break}return r},_fileCompare:function(n,t){return n.size==t.size&&n.name==t.name},_getFormatedSize:function(n){var r=this.options,i="B";return n>=t.TB?n/=t[i="TB"]:n>=t.GB?n/=t[i="GB"]:n>=t.MB?n/=t[i="MB"]:n>=t.KB&&(n/=t[i="KB"]),r.sizeFormat.replace(/^\d+([^\d]+)(\d*)/,function(t,u,f){return n=n.toFixed(f.length),(n+"").replace(".",u)+" "+r.lang[i]})},_onSelect:function(n){this.options.clearOnSelect&&(this.queue=[],this.files=[]);this._getFiles(n,r(this,function(t){t.all.length&&this.emit("select",t)!==!1&&this.add(t.files);FileAPI.reset(n.target)}))},_onActionClick:function(t){var f=t.currentTarget,r=n.attr(f,c),i=n(f).closest("["+s+"]",this.$el).attr(s),u=this._getFile(i),e=!0;this.$file(i).attr("disabled")||("file.remove"==r?u&&this.emit("fileRemove"+(u.complete?"Completed":""),u)&&this.remove(i):/^file\.rotate/.test(r)?this.rotate(i,/ccw/.test(r)?"-=90":"+=90"):e=!1);e&&t.preventDefault()},_listen:function(t,i,r){i&&f(n.trim(i).split(","),function(i){if(i=n.trim(i),v(i))n(i).on(t+".fileapi",r);else this.$el.on(t+".fileapi",i,r)},this)},_onSubmit:function(n){n.preventDefault();this.upload()},_onReset:function(n){n.preventDefault();this.clear()},_onAbort:function(n){n.preventDefault();this.abort()},_onDrop:function(n){this._getFiles(n,function(n){this.emit("drop",n)!==!1&&this.add(n.files)})},_onDropHover:function(t,i){if(this.emit("dropHover",{state:t,event:i})!==!1){var r=this.option("elements.dnd.hover");r&&n(i.currentTarget).toggleClass(r,t)}},_getFile:function(n){return t.filter(this.files,function(i){return t.uid(i)==n})[0]},_getUploadEvent:function(n,t){var i={xhr:n,file:this.xhr.currentFile,files:this.xhr.files,widget:this};return o(i,t)},_emitUploadEvent:function(n,t,i){var r=this._getUploadEvent(i);this.emit(n+"Upload",r)},_emitProgressEvent:function(n,t,i,r){var u=this._getUploadEvent(r,t);this.emit(n+"Progress",u)},_emitCompleteEvent:function(t,i,r,u){var f=this._getUploadEvent(r,{error:i,status:r.status,statusText:r.statusText,result:r.responseText});if(t=="file"&&(u.complete=!0),!i&&this.options.dataType=="json")try{f.result=n.parseJSON(f.result)}catch(i){f.error=i}this.emit(t+"Complete",f)},_onUploadEvent:function(n,t){var r=this,i=r.$progress,f=n.type,u;f=="progress"?i.stop().animate({width:t.loaded/t.total*100+"%"},300):f=="upload"?i.width(0):(u=function(){i.dequeue();r[r.options.clearOnComplete?"clear":"dequeue"]()},this.xhr=null,this.active=!1,i.length?i.queue(u):u())},_onFileUploadPrepare:function(i,r){var s=t.uid(i),e=this._rotate[s],h=this._crop[s],c=this._resize[s],l=this._getUploadEvent(this.xhr),u;(e||h||c)&&(u=n.extend(!0,{},r.imageTransform||{}),e=e||(this.options.imageAutoOrientation?"auto":void 0),n.isEmptyObject(u)||w(u)?(o(u,c),u.crop=h,u.rotate=e):f(u,function(n){o(n,c);n.crop=h;n.rotate=e}),r.imageTransform=u);l.file=i;l.options=r;this.emit("filePrepare",l)},_onFileUploadEvent:function(n,i){var o=this,r=n.type.substr(4),f=t.uid(i.file),e=this.$file(f),u=this._$fileprogress,h=this.options,s;this.__fileId!==f&&(this.__fileId=f,this._$fileprogress=u=this.$elem("file.progress",e));r=="progress"?u.stop().animate({width:i.loaded/i.total*100+"%"},300):(r=="upload"||r=="complete")&&(s=function(){var n="file."+r,t=o.$elem("file.remove",e);r=="upload"?(t.hide(),u.width(0)):h.onRemoveCompleted&&t.show();u.dequeue();o.$elem(n+".show",e).show();o.$elem(n+".hide",e).hide()},u.length?u.queue(s):s(),r=="complete"&&(this.uploaded.push(i.file),delete this._rotate[f]))},_redraw:function(i){var o=this.files,r=!!this.active,c=!o.length&&!r,u=!this.queue.length&&!r,l=[],a=0,e=this.$files,y=e.children().length,v=this.option("elements.file.preview");i&&this.$files.empty();f(o,function(i,r){var f=t.uid(i),o,u;l.push(i.name);a+=i.complete?0:i.size;e.length&&!this.$file(f).length&&(o=this.itemTplFn({$idx:y+r,uid:f,name:i.name,type:i.type,size:i.size,sizeText:this._getFormatedSize(i.size)}),u=n(o).attr(s,f),i.$el=u,e.append(u),i.complete&&(this.$elem("file.upload.hide",u).hide(),this.$elem("file.complete.hide",u).hide()),v.el&&this._makeFilePreview(f,i,v))},this);this.$elem("name").text(l.join(", "));this.$elem("size").text(u?"":this._getFormatedSize(a));this.$elem("empty.show").toggle(c);this.$elem("empty.hide").toggle(!c);this.$elem("emptyQueue.show").toggle(u);this.$elem("emptyQueue.hide").toggle(!u);this.$elem("active.show").toggle(r);this.$elem("active.hide").toggle(!r);this.$(".js-fileapi-wrapper,:file")[r?"attr":"removeAttr"]("aria-disabled",r)[h]("disabled",r);this._disableElem("ctrl.upload",u||r);this._disableElem("ctrl.reset",u||r);this._disableElem("ctrl.abort",!r)},_disableElem:function(n,t){this.$elem(n)[t?"attr":"removeAttr"]("aria-disabled","disabled")[h]("disabled",t)},_makeFilePreview:function(n,i,r,u){var f=this,o=u?f.$(r.el):f.$file(n).find(r.el),e,s;f._crop[n]||(/^image/.test(i.type)?(e=t.Image(i.src||i),s=function(){e.get(function(t,u){f._crop[n]||(t?(r.get&&r.get(o,i),f.emit("previewError",[t,i])):o.html(u))})},r.width&&e.preview(r.width,r.height),r.rotate&&e.rotate("auto"),r.processing?r.processing(i,e,s):s()):r.get&&r.get(o,i))},emit:function(t,i){var u=this.options,r=n.Event(t.toLowerCase()),f;return r.widget=this,t=n.camelCase("on-"+t),n.isFunction(u[t])&&(f=u[t].call(this.el,r,i)),this.$el.triggerHandler(r,i),f!==!1&&!r.isDefaultPrevented()},add:function(n,i){if(n=[].concat(n),n.length){var u=this.options,e=u.sortFn,r=u.elements.preview;e&&n.sort(e);r&&r.el&&f(n,function(n){this._makeFilePreview(t.uid(n),n,r,!0)},this);this.xhr&&this.xhr.append(n);this.queue=i?n:this.queue.concat(n);this.files=i?n:this.files.concat(n);this.active?(this.xhr.append(n),this._redraw(i)):(this._redraw(i),this.options.autoUpload&&this.upload())}},$:function(t,i){return typeof t=="string"&&(t=/^#/.test(t)?t:(i?n(i):this.$el).find(t)),n(t)},$elem:function(t,i,r){i&&i.jquery&&(r=i,i=!1);var u=this.option("elements."+t);return u===void 0&&i&&(u=this.option("elements."+t.substr(0,t.lastIndexOf(".")))),this.$(n.type(u)!="string"&&n.isEmptyObject(u)?[]:u,r)},$file:function(n){return this.$("["+s+'="'+n+'"]')},option:function(t,i){if(i!==void 0&&n.isPlainObject(i))return f(i,function(n,i){this.option(t+"."+i,n)},this),this;var o=this.options,r=o[t],e=0,s,u;if(t.indexOf(".")!=-1)for(r=o,t=t.split("."),s=t.length;e<s;e++){if(u=t[e],i!==void 0&&s-e==1){r[u]=i;break}else r[u]||(r[u]={});r=r[u]}else i!==void 0&&(o[t]=i);return i!==void 0&&(this._setOption(t,i,this._options[t]),this._options[t]=i),i!==void 0?i:r},_setOption:function(n,t){switch(n){case"accept":case"multiple":case"paramName":n=="paramName"&&(n="name");t&&this.$(":file")[h](n,t)}},serialize:function(){var t={},i;return this.$el.find(":input").each(function(r,u){(r=u.name)&&!u.disabled&&(u.checked||/select|textarea|input/i.test(u.nodeName)&&!/checkbox|radio|file/i.test(u.type))&&(i=n(u).val(),t[r]!==void 0?(t[r].push||(t[r]=[t[r]]),t[r].push(i)):t[r]=i)}),t},upload:function(){if(!this.active&&this.emit("beforeUpload",{widget:this,files:this.queue})){this.active=!0;var e=this.$el,n=this.options,u={},i={url:n.url,data:o({},this.serialize(),n.data),headers:n.headers,files:u,uploadRetry:0,networkDownRetryTimeout:5e3,chunkSize:0,chunkUploadRetry:3,chunkNetworkDownRetryTimeout:2e3,prepare:r(this,this._onFileUploadPrepare),imageOriginal:n.imageOriginal,imageTransform:n.imageTransform};u[e.find(":file").attr("name")||"files[]"]=this.queue;f(["Upload","Progress","Complete"],function(n){var t=n.toLowerCase();i[t]=r(this,this["_emit"+n+"Event"],"");i["file"+t]=r(this,this["_emit"+n+"Event"],"file")},this);this.xhr=t.upload(i);this._redraw()}},abort:function(n){this.active&&this.xhr&&this.xhr.abort(n)},crop:function(i,u){var s=t.uid(i),o=this.options,f=o.multiple?this.option("elements.file.preview"):o.elements.preview,e=(o.multiple?this.$file(s):this.$el).find(f&&f.el);e.length&&t.getInfo(i,r(this,function(r,s){if(r)this.emit("previewError",[r,i]);else{e.find("div>div").length||e.html(n("<div><div><\/div><\/div>").css(f).css("overflow","hidden"));this.__cropFile!==i&&(this.__cropFile=i,t.Image(i).rotate(o.imageAutoOrientation?"auto":0).get(function(t,i){e.find(">div>div").html(n(i).width("100%").height("100%"))},"exactFit"));var l=f.width,a=f.height,v=l,y=a,h=l/u.rw,c=a/u.rh;f.keepAspectRatio&&(h>1&&c>1?(h=c=1,y=u.h,v=u.w):h<c?(c=h,y=l*u.rh/u.rw):(h=c,v=a*u.rw/u.rh));e.find(">div>div").css({width:Math.round(h*s[u.flip?"height":"width"]),height:Math.round(c*s[u.flip?"width":"height"]),marginLeft:-Math.round(h*u.rx),marginTop:-Math.round(c*u.ry)});f.keepAspectRatio&&e.find(">div").css({width:Math.round(v),height:Math.round(y),marginLeft:v<l?Math.round((l-v)/2):0,marginTop:y<a?Math.round((a-y)/2):0})}}));this._crop[s]=u},resize:function(n,i,r,u){this._resize[t.uid(n)]={type:u,width:i,height:r}},rotate:function(i,r){var u=n.type(i)=="string"?i:t.uid(i),f=this.options,e=f.multiple?this.option("elements.file.preview"):f.elements.preview,s=(f.multiple?this.$file(u):this.$el).find(e&&e.el),o=this._rotate;o[u]=/([+-])=/.test(r)?r=(o[u]||0)+(RegExp.$1=="+"?1:-1)*r.substr(2):r;this._getFile(u).rotate=r;s.css({"-webkit-transform":"rotate("+r+"deg)","-moz-transform":"rotate("+r+"deg)",transform:"rotate("+r+"deg)"})},remove:function(n){var i=typeof n=="object"?t.uid(n):n,r=this.option("elements.preview.el");this.$file(i).remove();this.queue=t.filter(this.queue,function(n){return t.uid(n)!=i});this.files=t.filter(this.files,function(n){return t.uid(n)!=i});r&&!this.queue.length&&this.$(r).empty();this._redraw()},clear:function(){this._crop={};this._resize={};this._rotate={};this.queue=[];this.files=[];this.uploaded=[];this.$files.empty();this._redraw()},dequeue:function(){this.queue=[];this._redraw()},widget:function(){return this},toString:function(){return"[jQuery.FileAPI object]"},destroy:function(){this.$files.empty().append(this.$fileTpl);this.$el.off(".fileapi").removeData("fileapi");f(this.options.elements.ctrl,function(t){v(t)&&n(t).off("click.fileapi")})}};n.fn.fileapi=function(t,i){var r=this.data("fileapi"),u,f;if(r){if(t==="widget")return r;if(typeof t=="string")return u=r[t],n.isFunction(u)?f=u.apply(r,l.call(arguments,1)):u===void 0?f=r.option(t,i):t==="files"&&(f=u),f===void 0?this:f}else(t==null||typeof t=="object")&&this.data("fileapi",new a(this,t));return this};n.fn.fileapi.version="0.4.1";n.fn.fileapi.tpl=function(n){var i=0,t="__b+='";return n.replace(/(?:&lt;|<)%([-=])?([\s\S]+?)%(?:&gt;|>)|$/g,function(r,u,f,e){return t+=n.slice(i,e).replace(/[\r\n"']/g,function(n){return"\\"+n}),f&&(t+=u?"'+\n((__x=("+f+"))==null?'':"+(u=="-"?"__esc(__x)":"__x")+")\n+'":"';\n"+f+"\n__b+='"),i=e+r.length,r}),new Function("ctx","var __x,__b='',__esc=function(val){return typeof val=='string'?val.replace(/<\/g,'&lt;').replace(/\"/g,'&quot;'):val;};with(ctx||{}){\n"+t+"';\n}return __b;")};n.fn.webcam=function(i){var s=this,f=s,e=n(s),h="fileapi-camera",r=e.data(h);return r===!0?(t.log("[webcam.warn] not ready."),f=null):i==="widget"?f=r:i==="destroy"?(r.stop(),e.empty()):r?f=r[i]():r===!1?(t.log("[webcam.error] does not work."),f=null):(e.data(h,!0),i=o({success:u,error:u},i),FileAPI.Camera.publish(e,i,function(n,t){e.data(h,n?!1:t);i[n?"error":"success"].call(s,n||t)})),f};n.fn.cropper=function(i){var u=this,o=i.file,r,e;return typeof i=="string"?u.first().Jcrop.apply(u,arguments):(r=i.minSize||[0,0],e=i.aspectRatio||r[0]/r[1],n.isArray(i.minSize)&&i.aspectRatio===void 0&&e>0&&(i.aspectRatio=e),t.getInfo(o,function(s,h){var l=t.Image(o),c=i.maxSize,a=o.rotate;c&&l.resize(Math.max(c[0],r[0]),Math.max(c[1],r[1]),"max");l.rotate(a===void 0?"auto":a).get(function(t,r){var o=i.selection,y=Math.min(r.width,r.height),s=y,c=y/e,p=FileAPI.Image.exifOrientation[h.exif&&h.exif.Orientation]||0,l,a,v;o&&((/%/.test(o)||o>0&&o<1)&&(o=parseFloat(o,10)/(o>0?1:100),s*=o,c*=o),l=(r.width-s)/2,a=(r.height-c)/2,i.setSelect=[l|0,a|0,l+s|0,a+c|0]);f(["onSelect","onChange"],function(n,t){(t=i[n])&&(i[n]=function(n){var i=p%180,u=h.width,f=h.height,c=n.x/r.width,e=n.y/r.height,o=n.w/r.width,s=n.h/r.height,l=u*(i?e:c),a=f*(i?1-(n.x+n.w)/r.width:e),v=u*(i?s:o),y=f*(i?o:s);t({x:l,y:a,w:v,h:y,rx:c*(i?f:u),ry:e*(i?u:f),rw:o*(i?f:u),rh:s*(i?u:f),lx:n.x,ly:n.y,lw:n.w,lh:n.h,lx2:n.x2,ly2:n.y2,deg:p,flip:i})})});v=n("<div/>").css("lineHeight",0).append(n(r).css("margin",0));u.html(v);v.Jcrop(i).trigger("resize")})})),u}})(jQuery,FileAPI);
/*
//# sourceMappingURL=jquery.fileapi.min.js.map
*/